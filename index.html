<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow by tarmacqr</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    animation: { 
                        'blob': 'blob 10s infinite', 
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-15px)' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #fdfdff; background-image: radial-gradient(#e2e8f0 0.8px, transparent 0.8px); background-size: 30px 30px; }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 20px 50px rgba(0,0,0,0.05); }
        .gradient-text { background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .upload-area:hover { border-color: #6366f1; background-color: rgba(99, 102, 241, 0.02); }
    </style>
</head>
<body class="text-slate-800 selection:bg-indigo-100 min-h-screen flex flex-col">

    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute -top-[10%] -left-[10%] w-[60vw] h-[60vw] bg-indigo-100/50 rounded-full mix-blend-multiply filter blur-[120px] animate-blob"></div>
        <div class="absolute top-[20%] -right-[10%] w-[50vw] h-[50vw] bg-fuchsia-100/50 rounded-full mix-blend-multiply filter blur-[120px] animate-blob animation-delay-2000"></div>
    </div>

    <nav class="relative z-50 w-full px-8 py-8 flex justify-between items-center max-w-7xl mx-auto">
        <div class="flex items-center gap-4">
            <img src="https://www.tarmacq.com/Untitled (25).png" alt="Flow Logo" class="h-10 md:h-12 w-auto object-contain">
            <span class="text-2xl font-extrabold tracking-tight text-slate-900">Flow</span>
        </div>
        <div id="status-badge" class="flex gap-2 items-center px-4 py-2 rounded-full bg-white border border-slate-100 text-[10px] font-bold tracking-widest uppercase text-slate-400 shadow-sm backdrop-blur-md">
            <div class="w-2 h-2 rounded-full bg-slate-300 animate-pulse" id="status-dot"></div>
            <span id="status-text">Connecting...</span>
        </div>
    </nav>

    <main class="relative z-10 flex-grow container mx-auto px-6 py-12 flex flex-col items-center">
        <div class="max-w-3xl mx-auto mb-16 text-center">
            <h1 class="text-5xl md:text-7xl font-[800] mb-6 tracking-tight text-slate-900 leading-[1.1]" id="hero-title">
                Share files <span class="gradient-text">without limits.</span>
            </h1>
            <p class="text-lg text-slate-500 max-w-xl mx-auto" id="hero-desc">Direct browser-to-browser encrypted transfers.</p>
        </div>

        <div class="w-full max-w-xl relative group z-20 mb-24">
            <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-fuchsia-500 rounded-[2.5rem] blur opacity-10 group-hover:opacity-20 transition duration-1000"></div>
            <div class="relative glass-panel rounded-[2rem] p-6 min-h-[400px] flex flex-col">
                
                <div id="view-upload" class="flex-grow border-2 border-dashed border-slate-200 rounded-[1.5rem] p-10 flex flex-col items-center justify-center bg-white/40 upload-area transition-all cursor-pointer" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" class="hidden">
                    <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center mb-6 shadow-xl text-3xl text-indigo-500">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Ready to send?</h3>
                    <button class="px-8 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-indigo-600 transition shadow-lg">Select File</button>
                </div>

                <div id="view-link" class="hidden p-8 flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mb-6 text-2xl text-green-500">
                        <i class="fa-solid fa-link"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Link Generated</h3>
                    <div class="w-full bg-slate-50 p-2 rounded-xl border border-slate-100 flex gap-2 mb-4">
                        <input id="share-link" readonly type="text" class="w-full bg-transparent border-none focus:ring-0 text-slate-600 text-xs font-mono px-2" value="...">
                        <button onclick="copyLink()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-indigo-700 transition">Copy</button>
                    </div>
                    <p class="text-xs text-slate-400 font-medium">Keep this tab open until the transfer finishes.</p>
                </div>

                <div id="view-download" class="hidden p-8 flex flex-col items-center text-center">
                    <h3 class="text-xl font-bold text-slate-800 mb-1" id="dl-filename">File Found</h3>
                    <p class="text-slate-500 text-sm mb-10" id="dl-size">Waiting...</p>
                    <button id="btn-download" disabled onclick="requestDownload()" class="px-10 py-4 bg-indigo-600 text-white rounded-xl font-bold w-full shadow-lg">Start Download</button>
                </div>

                <div id="view-progress" class="hidden p-10 flex flex-col items-center">
                    <div class="w-full flex justify-between items-end mb-4">
                        <h3 class="text-sm font-bold text-slate-800" id="progress-status">Transmitting...</h3>
                        <p class="text-xs font-mono text-indigo-600 font-bold" id="progress-text">0%</p>
                    </div>
                    <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden mb-6">
                        <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const peer = new Peer({ debug: 1 });
        let conn = null, myId = null, selectedFile = null, fileMeta = null;
        let receivedChunks = [];
        let bytesReceived = 0;
        let startTime = 0;

        const showView = (id) => {
            ['upload', 'link', 'download', 'progress'].forEach(v => document.getElementById('view-' + v).classList.add('hidden'));
            document.getElementById('view-' + id).classList.remove('hidden');
        };

        function parseUrl() {
            const segments = window.location.pathname.split('/').filter(s => s.length > 0);
            const sendIdx = segments.indexOf('send');
            if (sendIdx !== -1 && segments[sendIdx + 1]) {
                return { hostId: segments[sendIdx + 1], fileName: decodeURIComponent(segments[sendIdx + 2] || "File") };
            }
            return null;
        }

        peer.on('open', (id) => {
            myId = id;
            updateStatus('online', 'READY');
            const route = parseUrl();
            if (route) { initReceiver(route.hostId, route.fileName); } 
            else { initSender(); }
        });

        function initSender() {
            const input = document.getElementById('file-input');
            input.onchange = (e) => { if(e.target.files[0]) prepareFile(e.target.files[0]); };
            peer.on('connection', (c) => {
                conn = c;
                updateStatus('connected', 'PEER CONNECTED');
                conn.on('open', () => {
                    conn.send({ type: 'meta', name: selectedFile.name, size: selectedFile.size, mime: selectedFile.type });
                });
                conn.on('data', (data) => { if (data === 'start-transfer') startChunkedUpload(); });
            });
        }

        // --- THE FIXED FUNCTION ---
        function prepareFile(file) {
            selectedFile = file;
            showView('link');
            const cleanName = encodeURIComponent(file.name.replace(/\s+/g, '-'));
            
            // Hardcoding your domain here ensures it always generates the correct link
            const shareUrl = `https://l.tarmacq.com/flow/send/${myId}/${cleanName}`;
            
            document.getElementById('share-link').value = shareUrl;
            
            // This updates the browser's address bar without refreshing
            window.history.pushState({}, "", `/flow/send/${myId}/${cleanName}`);
        }

        function startChunkedUpload() {
            showView('progress');
            startTime = Date.now();
            const chunkSize = 64 * 1024;
            let offset = 0;
            const readNext = () => {
                const reader = new FileReader();
                const slice = selectedFile.slice(offset, offset + chunkSize);
                reader.onload = (e) => {
                    conn.send({ type: 'chunk', data: e.target.result, offset: offset });
                    offset += e.target.result.byteLength;
                    updateProgressUI(offset, selectedFile.size, Math.floor((offset / selectedFile.size) * 100));
                    if (offset < selectedFile.size) setTimeout(readNext, 1);
                    else {
                        conn.send({ type: 'done' });
                        document.getElementById('progress-status').innerText = "Complete!";
                    }
                };
                reader.readAsArrayBuffer(slice);
            };
            readNext();
        }

        function initReceiver(hostId, name) {
            showView('download');
            document.getElementById('dl-filename').innerText = name;
            conn = peer.connect(hostId);
            conn.on('data', (data) => {
                if (data.type === 'meta') {
                    fileMeta = data;
                    document.getElementById('dl-size').innerText = (data.size / (1024*1024)).toFixed(2) + " MB";
                    document.getElementById('btn-download').disabled = false;
                }
                if (data.type === 'chunk') {
                    if (bytesReceived === 0) startTime = Date.now();
                    receivedChunks.push(data.data);
                    bytesReceived += data.data.byteLength;
                    updateProgressUI(bytesReceived, fileMeta.size, Math.floor((bytesReceived / fileMeta.size) * 100));
                }
                if (data.type === 'done') {
                    const blob = new Blob(receivedChunks, { type: fileMeta.mime });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = fileMeta.name;
                    a.click();
                }
            });
        }

        function requestDownload() { showView('progress'); conn.send('start-transfer'); }
        function updateProgressUI(current, total, pct) {
            document.getElementById('progress-bar').style.width = pct + "%";
            document.getElementById('progress-text').innerText = pct + "%";
        }
        function updateStatus(type, text) {
            document.getElementById('status-dot').className = "w-2 h-2 rounded-full " + (type === 'online' ? 'bg-green-500' : 'bg-indigo-500');
            document.getElementById('status-text').innerText = text;
        }
        function copyLink() {
            const input = document.getElementById('share-link');
            input.select();
            document.execCommand('copy');
        }
    </script>
</body>
</html>
